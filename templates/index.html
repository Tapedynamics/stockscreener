<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Portfolio Manager - Stock Screener</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0e27;
            color: #e4e8f0;
            min-height: 100vh;
            padding: 0;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1a1f3a 0%, #2d1b3d 100%);
            padding: 20px 40px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 1.8em;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .ai-status {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(102, 126, 234, 0.1);
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .ai-status-text {
            font-size: 0.9em;
            color: #667eea;
            font-weight: 600;
        }

        /* Main Container */
        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 40px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1a1f3a 0%, #2d1b3d 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .stat-label {
            font-size: 0.85em;
            color: #8b92a7;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #fff;
        }

        .stat-change {
            font-size: 0.9em;
            margin-top: 8px;
        }

        .stat-change.positive {
            color: #10b981;
        }

        .stat-change.negative {
            color: #ef4444;
        }

        /* Control Panel */
        .control-panel {
            background: linear-gradient(135deg, #1a1f3a 0%, #2d1b3d 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-info {
            flex: 1;
        }

        .next-rebalance {
            font-size: 0.9em;
            color: #8b92a7;
            margin-bottom: 5px;
        }

        .rebalance-time {
            font-size: 1.2em;
            font-weight: 600;
            color: #667eea;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1em;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px 30px;
            font-size: 1em;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* Tabs */
        .tabs-container {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .tab-button {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #8b92a7;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab-button:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(102, 126, 234, 0.3);
            color: #667eea;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
            display: none;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Portfolio Grid */
        .portfolio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .portfolio-section {
            background: linear-gradient(135deg, #1a1f3a 0%, #2d1b3d 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .portfolio-section:hover {
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: 1.2em;
            font-weight: 700;
            color: #fff;
        }

        .section-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-profit {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge-hold {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .badge-buffer {
            background: rgba(139, 146, 167, 0.2);
            color: #8b92a7;
            border: 1px solid rgba(139, 146, 167, 0.3);
        }

        /* Stock Cards */
        .stock-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .stock-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .stock-card:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(102, 126, 234, 0.5);
            transform: translateX(5px);
        }

        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stock-ticker {
            font-size: 1.1em;
            font-weight: 700;
            color: #fff;
        }

        .stock-performance {
            font-size: 0.9em;
            font-weight: 600;
        }

        .stock-performance.positive {
            color: #10b981;
        }

        .stock-performance.negative {
            color: #ef4444;
        }

        .stock-performance.neutral {
            color: #8b92a7;
        }

        .stock-meta {
            display: flex;
            gap: 15px;
            margin-top: 8px;
            font-size: 0.85em;
            color: #8b92a7;
        }

        /* Activity Log */
        .activity-log {
            background: linear-gradient(135deg, #1a1f3a 0%, #2d1b3d 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #fff;
        }

        .log-entries {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border-left: 3px solid #667eea;
        }

        .log-time {
            font-size: 0.85em;
            color: #8b92a7;
            white-space: nowrap;
        }

        .log-content {
            flex: 1;
        }

        .log-action {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .log-action.buy {
            color: #10b981;
        }

        .log-action.sell {
            color: #ef4444;
        }

        .log-action.hold {
            color: #fbbf24;
        }

        .log-description {
            font-size: 0.9em;
            color: #8b92a7;
        }

        /* Error */
        .error {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .main-container {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .portfolio-grid {
                grid-template-columns: 1fr;
            }

            .control-panel {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
        }

        /* Scrollbar */
        .log-entries::-webkit-scrollbar {
            width: 6px;
        }

        .log-entries::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .log-entries::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 10px;
        }

        /* Settings Panel */
        .settings-section {
            background: rgba(255, 255, 255, 0.03);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .setting-item {
            margin-bottom: 20px;
        }

        .setting-label {
            display: block;
            color: #8b92a7;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .setting-input {
            width: 100%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .setting-input:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.08);
        }

        .setting-input:hover {
            border-color: rgba(102, 126, 234, 0.5);
        }

        /* Chart Styles */
        .chart-container {
            background: rgba(255, 255, 255, 0.03);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            margin-bottom: 30px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: 700;
            color: #fff;
        }

        .timeframe-selector {
            display: flex;
            gap: 10px;
            background: rgba(255, 255, 255, 0.05);
            padding: 5px;
            border-radius: 8px;
        }

        .timeframe-btn {
            background: transparent;
            border: none;
            color: #8b92a7;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .timeframe-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #667eea;
        }

        .timeframe-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .chart-canvas {
            position: relative;
            height: 400px;
        }

        .chart-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .chart-stat {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .chart-stat-label {
            font-size: 0.85em;
            color: #8b92a7;
            margin-bottom: 5px;
        }

        .chart-stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #fff;
        }

        @media (max-width: 768px) {
            .chart-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .timeframe-selector {
                width: 100%;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>ü§ñ AI Portfolio Manager</h1>
        <div class="ai-status">
            <div class="status-dot"></div>
            <span class="ai-status-text">Agent Active</span>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Portfolio Value</div>
                <div class="stat-value">$150,000</div>
                <div class="stat-change positive">+12.5% All Time</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Positions</div>
                <div class="stat-value" id="totalPositions">15</div>
                <div class="stat-change neutral">Active Stocks</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Weekly Performance</div>
                <div class="stat-value">+3.2%</div>
                <div class="stat-change positive">+$4,800</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Next Rebalance</div>
                <div class="stat-value" id="nextRebalanceDay">Monday</div>
                <div class="stat-change neutral" id="nextRebalanceTime">19:00 CET</div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <div class="control-info">
                <div class="next-rebalance">AI Agent Status</div>
                <div class="rebalance-time">Automated Weekly Rebalancing at Monday 19:00</div>
            </div>
            <div style="display: flex; gap: 15px;">
                <button class="btn-primary" id="runScreener" onclick="runScreener()">
                    Run Screener Now
                </button>
                <button class="btn-secondary" onclick="exportCSV()">
                    üì• Export CSV
                </button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs-container">
            <button class="tab-button active" onclick="switchTab(event, 'portfolio')">üìä Portfolio</button>
            <button class="tab-button" onclick="switchTab(event, 'history')">üìú History</button>
            <button class="tab-button" onclick="switchTab(event, 'charts')">üìà Charts</button>
            <button class="tab-button" onclick="switchTab(event, 'compare')">‚öñÔ∏è Compare</button>
            <button class="tab-button" onclick="switchTab(event, 'benchmark')">üìä Benchmark</button>
            <button class="tab-button" onclick="switchTab(event, 'settings')">‚öôÔ∏è Settings</button>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>AI Agent analyzing market data...</p>
        </div>

        <!-- Error -->
        <div class="error" id="error"></div>

        <!-- Tab Content: Portfolio -->
        <div id="tab-portfolio" class="tab-content active">
            <!-- Portfolio Grid -->
            <div class="portfolio-grid">
                <!-- Take Profit Section -->
                <div class="portfolio-section">
                    <div class="section-header">
                        <div class="section-title">Take Profit</div>
                        <div class="section-badge badge-profit">Top 3</div>
                    </div>
                    <div class="stock-cards" id="takeProfitList"></div>
                </div>

                <!-- Hold Section -->
                <div class="portfolio-section">
                    <div class="section-header">
                        <div class="section-title">Core Holdings</div>
                        <div class="section-badge badge-hold">10 Positions</div>
                    </div>
                    <div class="stock-cards" id="holdList"></div>
                </div>

                <!-- Buffer Section -->
                <div class="portfolio-section">
                    <div class="section-header">
                        <div class="section-title">Buffer Zone</div>
                        <div class="section-badge badge-buffer">2 Reserve</div>
                    </div>
                    <div class="stock-cards" id="bufferList"></div>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="activity-log">
                <div class="log-header">
                    <div class="log-title">üìã AI Agent Activity Log</div>
                    <div class="stat-change neutral">Last updated: Just now</div>
                </div>
                <div class="log-entries">
                    <div class="log-entry">
                        <div class="log-time">Just now</div>
                        <div class="log-content">
                            <div class="log-action">Portfolio Scanned</div>
                            <div class="log-description">AI Agent analyzed Finviz screener and identified 15 high-potential stocks matching criteria</div>
                        </div>
                    </div>
                    <div class="log-entry">
                        <div class="log-time">Mon 19:00</div>
                        <div class="log-content">
                            <div class="log-action hold">HOLD Decision</div>
                            <div class="log-description">Maintained current positions - All stocks still meet quality criteria</div>
                        </div>
                    </div>
                    <div class="log-entry">
                        <div class="log-time">Last Week</div>
                        <div class="log-content">
                            <div class="log-action buy">BUY Signal</div>
                            <div class="log-description">Added 2 new positions to portfolio based on improved fundamentals</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: History -->
        <div id="tab-history" class="tab-content">
            <div class="activity-log">
                <div class="log-header">
                    <div class="log-title">üìú Portfolio History</div>
                    <div class="stat-change neutral">Showing last 10 snapshots</div>
                </div>
                <div id="historyList" class="log-entries">
                    <div class="log-entry">
                        <div class="log-time">Loading...</div>
                        <div class="log-content">
                            <div class="log-description">Fetching portfolio history...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Charts -->
        <div id="tab-charts" class="tab-content">
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">üìà Portfolio Performance (Simulated from Jan 1, 2025)</div>
                    <div class="timeframe-selector">
                        <button class="timeframe-btn" onclick="changeTimeframe('1M')">1M</button>
                        <button class="timeframe-btn" onclick="changeTimeframe('3M')">3M</button>
                        <button class="timeframe-btn" onclick="changeTimeframe('6M')">6M</button>
                        <button class="timeframe-btn active" onclick="changeTimeframe('YTD')">YTD</button>
                        <button class="timeframe-btn" onclick="changeTimeframe('ALL')">ALL</button>
                    </div>
                </div>

                <div class="chart-canvas">
                    <canvas id="portfolioChart"></canvas>
                </div>

                <div class="chart-stats">
                    <div class="chart-stat">
                        <div class="chart-stat-label">Initial Value</div>
                        <div class="chart-stat-value" id="chart-initial-value">$150,000</div>
                    </div>
                    <div class="chart-stat">
                        <div class="chart-stat-label">Current Value</div>
                        <div class="chart-stat-value" id="chart-current-value">$150,000</div>
                    </div>
                    <div class="chart-stat">
                        <div class="chart-stat-label">Total Return</div>
                        <div class="chart-stat-value" id="chart-total-return" style="color: #10b981;">+0.00%</div>
                    </div>
                    <div class="chart-stat">
                        <div class="chart-stat-label">Days Tracked</div>
                        <div class="chart-stat-value" id="chart-days-tracked">0</div>
                    </div>
                </div>
            </div>

            <div style="padding: 20px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; border: 1px solid rgba(102, 126, 234, 0.3); color: #667eea;">
                <strong>‚ÑπÔ∏è Simulation Note:</strong> This chart simulates how your current portfolio would have performed if you had started with it on January 1, 2025. It uses real historical price data from Yahoo Finance to calculate daily portfolio values based on equal-weight distribution.
            </div>
        </div>

        <!-- Tab Content: Compare (Placeholder) -->
        <div id="tab-compare" class="tab-content">
            <div class="activity-log">
                <div class="log-header">
                    <div class="log-title">‚öñÔ∏è Compare Snapshots</div>
                </div>
                <div style="padding: 60px; text-align: center; color: #8b92a7;">
                    <h3>Coming Soon</h3>
                    <p>Compare different portfolio snapshots side by side</p>
                </div>
            </div>
        </div>

        <!-- Tab Content: Benchmark (Placeholder) -->
        <div id="tab-benchmark" class="tab-content">
            <div class="activity-log">
                <div class="log-header">
                    <div class="log-title">üìä S&P 500 Benchmark</div>
                </div>
                <div style="padding: 60px; text-align: center; color: #8b92a7;">
                    <h3>Coming Soon</h3>
                    <p>Compare portfolio performance against S&P 500 index</p>
                </div>
            </div>
        </div>

        <!-- Tab Content: Settings -->
        <div id="tab-settings" class="tab-content">
            <div class="activity-log">
                <div class="log-header">
                    <div class="log-title">‚öôÔ∏è Settings</div>
                    <button class="btn-secondary" onclick="saveSettings()" style="padding: 10px 20px; font-size: 0.9em;">
                        üíæ Save Settings
                    </button>
                </div>

                <div style="padding: 30px;">
                    <!-- Scheduler Settings -->
                    <div class="settings-section">
                        <h3 style="color: #fff; margin-bottom: 20px; font-size: 1.2em;">üïê Scheduler Configuration</h3>

                        <div class="setting-item">
                            <label class="setting-label">Rebalance Day</label>
                            <select id="setting-day" class="setting-input">
                                <option value="mon">Monday</option>
                                <option value="tue">Tuesday</option>
                                <option value="wed">Wednesday</option>
                                <option value="thu">Thursday</option>
                                <option value="fri">Friday</option>
                                <option value="sat">Saturday</option>
                                <option value="sun">Sunday</option>
                            </select>
                        </div>

                        <div class="setting-item">
                            <label class="setting-label">Rebalance Time (24h format)</label>
                            <input type="time" id="setting-time" class="setting-input" value="19:00">
                        </div>

                        <div class="setting-item">
                            <label class="setting-label">Timezone</label>
                            <select id="setting-timezone" class="setting-input">
                                <option value="Europe/Rome">Europe/Rome (CET)</option>
                                <option value="America/New_York">America/New_York (EST)</option>
                                <option value="America/Los_Angeles">America/Los_Angeles (PST)</option>
                                <option value="Asia/Tokyo">Asia/Tokyo (JST)</option>
                                <option value="UTC">UTC</option>
                            </select>
                        </div>
                    </div>

                    <!-- Portfolio Settings -->
                    <div class="settings-section" style="margin-top: 40px;">
                        <h3 style="color: #fff; margin-bottom: 20px; font-size: 1.2em;">üìä Portfolio Configuration</h3>

                        <div class="setting-item">
                            <label class="setting-label">Initial Portfolio Value ($)</label>
                            <input type="number" id="setting-initial-value" class="setting-input" value="150000" step="1000">
                        </div>

                        <div class="setting-item">
                            <label class="setting-label">Take Profit Positions</label>
                            <input type="number" id="setting-take-profit-count" class="setting-input" value="3" min="1" max="10">
                        </div>

                        <div class="setting-item">
                            <label class="setting-label">Hold Positions</label>
                            <input type="number" id="setting-hold-count" class="setting-input" value="10" min="5" max="20">
                        </div>

                        <div class="setting-item">
                            <label class="setting-label">Buffer Positions</label>
                            <input type="number" id="setting-buffer-count" class="setting-input" value="2" min="1" max="5">
                        </div>
                    </div>

                    <!-- Notification Settings -->
                    <div class="settings-section" style="margin-top: 40px;">
                        <h3 style="color: #fff; margin-bottom: 20px; font-size: 1.2em;">üîî Notifications</h3>

                        <div class="setting-item">
                            <label class="setting-label">
                                <input type="checkbox" id="setting-notify-rebalance" style="margin-right: 10px;">
                                Notify on Rebalance
                            </label>
                        </div>

                        <div class="setting-item">
                            <label class="setting-label">
                                <input type="checkbox" id="setting-notify-changes" style="margin-right: 10px;" checked>
                                Notify on Portfolio Changes
                            </label>
                        </div>
                    </div>

                    <div style="margin-top: 30px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; color: #667eea;">
                        <strong>Note:</strong> Some settings may require server restart to take effect. Changes to scheduler will be applied on next deployment.
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ========================================
        // GLOBAL STATE
        // ========================================
        let portfolioChartInstance = null;
        let currentTimeframe = 'YTD';

        // ========================================
        // SCREENER FUNCTIONALITY
        // ========================================
        async function runScreener() {
            console.log('Running screener...');
            const button = document.getElementById('runScreener');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');

            // Reset UI
            button.disabled = true;
            button.textContent = 'Running...';
            loading.style.display = 'block';
            error.style.display = 'none';

            try {
                const response = await fetch('/api/screener');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Screener response:', data);

                if (data.success) {
                    // New API structure: data.data contains {basket, snapshot_id, performance}
                    const result = data.data;
                    console.log('Result object:', result);

                    // Extract basket - handle both new and old structures
                    const basket = result.basket || result.data || result;
                    console.log('Basket object:', basket);

                    if (!basket || !basket.take_profit) {
                        console.error('Invalid basket structure:', basket);
                        showError('Invalid data structure received from server');
                        return;
                    }

                    displayResults(basket, result.performance || {});
                    await loadActivityLog();
                    await loadPortfolioStats();
                    console.log('Screener completed successfully');
                } else {
                    showError(data.error || 'Unknown error');
                }
            } catch (err) {
                console.error('Screener error:', err);
                showError('Connection error: ' + err.message);
            } finally {
                button.disabled = false;
                button.textContent = 'Run Screener Now';
                loading.style.display = 'none';
            }
        }

        // ========================================
        // ACTIVITY LOG
        // ========================================
        async function loadActivityLog() {
            try {
                const response = await fetch('/api/activity-log');
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    displayActivityLog(data.data);
                }
            } catch (err) {
                console.error('Error loading activity log:', err);
            }
        }

        function displayActivityLog(logs) {
            const logEntries = document.querySelector('.log-entries');
            if (!logEntries) return;

            logEntries.innerHTML = '';

            logs.forEach(log => {
                const actionClass = log.action_type.toLowerCase();
                const timeAgo = formatTimeAgo(log.timestamp);

                logEntries.innerHTML += `
                    <div class="log-entry">
                        <div class="log-time">${timeAgo}</div>
                        <div class="log-content">
                            <div class="log-action ${actionClass}">${formatActionType(log.action_type)}</div>
                            <div class="log-description">${log.description}</div>
                        </div>
                    </div>
                `;
            });
        }

        function formatActionType(actionType) {
            const types = {
                'BUY': 'BUY Signal',
                'SELL': 'SELL Signal',
                'HOLD': 'HOLD Decision',
                'REBALANCE': 'Rebalance',
                'SCAN': 'Portfolio Scanned',
                'INIT': 'Portfolio Initialized'
            };
            return types[actionType] || actionType;
        }

        function formatTimeAgo(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' min ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' hr ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + ' days ago';

            return date.toLocaleDateString();
        }

        // ========================================
        // PORTFOLIO DISPLAY
        // ========================================
        function displayResults(basket, performance = {}) {
            console.log('Displaying portfolio results:', basket);

            // Validate basket structure
            if (!basket || typeof basket !== 'object') {
                console.error('Invalid basket:', basket);
                showError('Invalid portfolio data');
                return;
            }

            const takeProfitList = document.getElementById('takeProfitList');
            const holdList = document.getElementById('holdList');
            const bufferList = document.getElementById('bufferList');
            const totalPositions = document.getElementById('totalPositions');

            // Clear previous results
            takeProfitList.innerHTML = '';
            holdList.innerHTML = '';
            bufferList.innerHTML = '';

            // Update total positions
            totalPositions.textContent = basket.total_found || 0;

            // Take Profit - with safety check
            if (Array.isArray(basket.take_profit)) {
                basket.take_profit.forEach((ticker, index) => {
                    const perf = performance[ticker]?.performance || null;
                    takeProfitList.innerHTML += createStockCard(ticker, index + 1, 'profit', perf);
                });
            } else {
                console.warn('take_profit is not an array:', basket.take_profit);
            }

            // Hold - with safety check
            if (Array.isArray(basket.hold)) {
                basket.hold.forEach((ticker, index) => {
                    const perf = performance[ticker]?.performance || null;
                    holdList.innerHTML += createStockCard(ticker, index + 4, 'hold', perf);
                });
            } else {
                console.warn('hold is not an array:', basket.hold);
            }

            // Buffer - with safety check
            if (Array.isArray(basket.buffer)) {
                basket.buffer.forEach((ticker, index) => {
                    const perf = performance[ticker]?.performance || null;
                    bufferList.innerHTML += createStockCard(ticker, index + 14, 'buffer', perf);
                });
            } else {
                console.warn('buffer is not an array:', basket.buffer);
            }
        }

        function createStockCard(ticker, position, type, performance = null) {
            // Use real performance or show loading
            let perfDisplay = '';
            if (performance !== null) {
                const perf = parseFloat(performance).toFixed(2);
                const perfClass = perf > 0 ? 'positive' : perf < 0 ? 'negative' : 'neutral';
                const perfSign = perf > 0 ? '+' : '';
                perfDisplay = `<div class="stock-performance ${perfClass}">${perfSign}${perf}%</div>`;
            } else {
                perfDisplay = `<div class="stock-performance neutral">--</div>`;
            }

            return `
                <div class="stock-card">
                    <div class="stock-header">
                        <div class="stock-ticker">${ticker}</div>
                        ${perfDisplay}
                    </div>
                    <div class="stock-meta">
                        <span>Position #${position}</span>
                        <span>‚Ä¢</span>
                        <span>${type === 'profit' ? 'Take Profit' : type === 'hold' ? 'Hold' : 'Buffer'}</span>
                    </div>
                </div>
            `;
        }

        async function loadPortfolioStats() {
            try {
                const response = await fetch('/api/portfolio/performance');
                const data = await response.json();

                if (data.success) {
                    updateStatsDisplay(data.data);
                }
            } catch (err) {
                console.error('Error loading portfolio stats:', err);
            }
        }

        function updateStatsDisplay(stats) {
            // Update portfolio value
            const valueElem = document.querySelector('.stat-card:nth-child(1) .stat-value');
            if (valueElem) {
                valueElem.textContent = `$${stats.total_value.toLocaleString()}`;
            }

            // Update weekly performance
            const perfElem = document.querySelector('.stat-card:nth-child(3) .stat-value');
            const gainElem = document.querySelector('.stat-card:nth-child(3) .stat-change');
            if (perfElem && gainElem) {
                const perfClass = stats.weekly_performance > 0 ? 'positive' : stats.weekly_performance < 0 ? 'negative' : 'neutral';
                const perfSign = stats.weekly_performance > 0 ? '+' : '';
                const gainSign = stats.weekly_gain > 0 ? '+' : '';

                perfElem.textContent = `${perfSign}${stats.weekly_performance}%`;
                gainElem.textContent = `${gainSign}$${Math.abs(stats.weekly_gain).toLocaleString()}`;
                gainElem.className = `stat-change ${perfClass}`;
            }
        }

        function showError(message) {
            const error = document.getElementById('error');
            error.textContent = 'Error: ' + message;
            error.style.display = 'block';
        }

        // ========================================
        // PAGE INITIALIZATION
        // ========================================
        window.addEventListener('load', async () => {
            console.log('Page loaded - Initializing application...');

            try {
                // Load activity log
                console.log('Loading activity log...');
                await loadActivityLog();

                // Load latest portfolio
                console.log('Loading latest portfolio...');
                await loadLatestPortfolio();

                // Load scheduler status
                console.log('Loading scheduler status...');
                await loadSchedulerStatus();

                // Load portfolio stats
                console.log('Loading portfolio stats...');
                await loadPortfolioStats();

                console.log('Application initialized successfully');
            } catch (err) {
                console.error('Initialization error:', err);
            }
        });

        async function loadSchedulerStatus() {
            try {
                const response = await fetch('/api/scheduler/status');
                const data = await response.json();

                if (data.success && data.data.next_run) {
                    const nextRun = new Date(data.data.next_run);
                    const dayName = nextRun.toLocaleDateString('en-US', { weekday: 'long' });
                    const time = nextRun.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', timeZone: 'Europe/Rome' });

                    document.getElementById('nextRebalanceDay').textContent = dayName;
                    document.getElementById('nextRebalanceTime').textContent = time + ' CET';
                }
            } catch (err) {
                console.log('Could not load scheduler status');
            }
        }

        async function loadLatestPortfolio() {
            try {
                const response = await fetch('/api/portfolio/latest');
                const data = await response.json();

                if (data.success) {
                    // Show existing portfolio without running screener
                    displayResults({
                        take_profit: data.data.take_profit,
                        hold: data.data.hold,
                        buffer: data.data.buffer,
                        total_found: data.data.total_stocks
                    });
                }
            } catch (err) {
                // No previous portfolio, that's ok
                console.log('No previous portfolio found');
            }
        }

        // ========================================
        // TAB NAVIGATION
        // ========================================
        function switchTab(event, tabName) {
            console.log('Switching to tab:', tabName);

            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            const selectedTab = document.getElementById(`tab-${tabName}`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            // Add active class to clicked button
            if (event && event.target) {
                event.target.classList.add('active');
            }

            // Load data for specific tabs
            if (tabName === 'history') {
                loadPortfolioHistory();
            } else if (tabName === 'settings') {
                loadSettings();
            } else if (tabName === 'charts') {
                loadChart(currentTimeframe);
            }
        }

        // ========================================
        // PORTFOLIO HISTORY
        // ========================================
        async function loadPortfolioHistory() {
            console.log('Loading portfolio history...');
            try {
                const response = await fetch('/api/portfolio/history');
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    displayHistory(data.data);
                } else {
                    document.getElementById('historyList').innerHTML = `
                        <div class="log-entry">
                            <div class="log-content">
                                <div class="log-description">No portfolio history yet. Run the screener to create your first snapshot.</div>
                            </div>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Error loading history:', err);
            }
        }

        function displayHistory(history) {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';

            history.forEach((snapshot, index) => {
                const date = new Date(snapshot.timestamp);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                const isLatest = index === 0;

                historyList.innerHTML += `
                    <div class="log-entry">
                        <div class="log-time">${dateStr}</div>
                        <div class="log-content">
                            <div class="log-action">${isLatest ? 'üü¢ Current Portfolio' : 'üì∏ Snapshot #' + snapshot.id}</div>
                            <div class="log-description">
                                <strong>Top 3:</strong> ${snapshot.take_profit.join(', ')}<br>
                                <strong>Hold:</strong> ${snapshot.hold.join(', ')}<br>
                                <strong>Buffer:</strong> ${snapshot.buffer.join(', ')}
                                ${snapshot.notes ? '<br><em>' + snapshot.notes + '</em>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // ========================================
        // CSV EXPORT
        // ========================================
        function exportCSV() {
            console.log('Exporting portfolio to CSV...');
            fetch('/api/portfolio/latest')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const portfolio = data.data;

                        // Create CSV content
                        let csv = 'Category,Position,Ticker\n';

                        portfolio.take_profit.forEach((ticker, i) => {
                            csv += `Take Profit,${i + 1},${ticker}\n`;
                        });

                        portfolio.hold.forEach((ticker, i) => {
                            csv += `Hold,${i + 4},${ticker}\n`;
                        });

                        portfolio.buffer.forEach((ticker, i) => {
                            csv += `Buffer,${i + 14},${ticker}\n`;
                        });

                        // Download CSV
                        const blob = new Blob([csv], { type: 'text/csv' });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `portfolio_${new Date().toISOString().split('T')[0]}.csv`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                    }
                })
                .catch(err => console.error('Export error:', err));
        }

        // ========================================
        // SETTINGS MANAGEMENT
        // ========================================
        async function loadSettings() {
            console.log('Loading settings...');
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();

                if (data.success) {
                    const settings = data.data;

                    // Scheduler settings
                    if (settings.scheduler_day) document.getElementById('setting-day').value = settings.scheduler_day;
                    if (settings.scheduler_time) document.getElementById('setting-time').value = settings.scheduler_time;
                    if (settings.scheduler_timezone) document.getElementById('setting-timezone').value = settings.scheduler_timezone;

                    // Portfolio settings
                    if (settings.initial_value) document.getElementById('setting-initial-value').value = settings.initial_value;
                    if (settings.take_profit_count) document.getElementById('setting-take-profit-count').value = settings.take_profit_count;
                    if (settings.hold_count) document.getElementById('setting-hold-count').value = settings.hold_count;
                    if (settings.buffer_count) document.getElementById('setting-buffer-count').value = settings.buffer_count;

                    // Notification settings
                    if (settings.notify_rebalance !== undefined) document.getElementById('setting-notify-rebalance').checked = settings.notify_rebalance === 'true';
                    if (settings.notify_changes !== undefined) document.getElementById('setting-notify-changes').checked = settings.notify_changes === 'true';
                }
            } catch (err) {
                console.error('Error loading settings:', err);
            }
        }

        async function saveSettings() {
            const settings = {
                scheduler_day: document.getElementById('setting-day').value,
                scheduler_time: document.getElementById('setting-time').value,
                scheduler_timezone: document.getElementById('setting-timezone').value,
                initial_value: document.getElementById('setting-initial-value').value,
                take_profit_count: document.getElementById('setting-take-profit-count').value,
                hold_count: document.getElementById('setting-hold-count').value,
                buffer_count: document.getElementById('setting-buffer-count').value,
                notify_rebalance: document.getElementById('setting-notify-rebalance').checked.toString(),
                notify_changes: document.getElementById('setting-notify-changes').checked.toString()
            };

            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Settings saved successfully!\n\nNote: Some changes may require server restart to take effect.');
                } else {
                    alert('‚ùå Error saving settings: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('‚ùå Error saving settings: ' + err.message);
            }
        }

        // ========================================
        // CHART FUNCTIONALITY
        // ========================================
        function changeTimeframe(timeframe) {
            console.log('Changing timeframe to:', timeframe);
            currentTimeframe = timeframe;

            // Update active button
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === timeframe) {
                    btn.classList.add('active');
                }
            });

            // Load chart with new timeframe
            loadChart(timeframe);
        }

        async function loadChart(timeframe = 'YTD') {
            console.log('Loading chart for timeframe:', timeframe);

            try {
                currentTimeframe = timeframe;

                // Fetch chart data
                const response = await fetch(`/api/portfolio/chart?timeframe=${timeframe}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Chart data received:', data);

                if (data.success && data.data) {
                    const result = data.data;
                    const chartData = result.chart_data || result.data || result;
                    renderChart(chartData);
                    updateChartStats(chartData);
                } else {
                    console.error('Error loading chart:', data.error || 'No data');
                }
            } catch (err) {
                console.error('Chart loading error:', err);
            }
        }

        function renderChart(chartData) {
            console.log('Rendering chart with data:', chartData);

            // Validate data
            if (!chartData || !chartData.dates || !chartData.values) {
                console.error('Invalid chart data:', chartData);
                return;
            }

            if (chartData.dates.length === 0) {
                console.warn('No data points to display');
                return;
            }

            const canvas = document.getElementById('portfolioChart');
            if (!canvas) {
                console.error('Canvas element not found');
                return;
            }

            const ctx = canvas.getContext('2d');

            // Destroy existing chart
            if (portfolioChartInstance) {
                console.log('Destroying previous chart instance');
                portfolioChartInstance.destroy();
                portfolioChartInstance = null;
            }

            // Prepare data
            const labels = chartData.dates.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            const values = chartData.values;

            console.log(`Rendering ${labels.length} data points`);

            // Create gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(102, 126, 234, 0.3)');
            gradient.addColorStop(1, 'rgba(102, 126, 234, 0.0)');

            // Create chart
            portfolioChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Portfolio Value',
                        data: values,
                        borderColor: '#667eea',
                        backgroundColor: gradient,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: '#667eea',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 31, 58, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#e4e8f0',
                            borderColor: 'rgba(102, 126, 234, 0.5)',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#8b92a7',
                                maxRotation: 0,
                                autoSkipPadding: 20
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#8b92a7',
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        function updateChartStats(chartData) {
            // Initial value
            const initialValue = chartData.initial_value || 150000;
            document.getElementById('chart-initial-value').textContent = '$' + initialValue.toLocaleString();

            // Current value
            const currentValue = chartData.current_value || initialValue;
            document.getElementById('chart-current-value').textContent = '$' + currentValue.toLocaleString();

            // Total return
            const totalReturn = chartData.total_return || 0;
            const returnElem = document.getElementById('chart-total-return');
            const returnSign = totalReturn >= 0 ? '+' : '';
            returnElem.textContent = returnSign + totalReturn.toFixed(2) + '%';
            returnElem.style.color = totalReturn >= 0 ? '#10b981' : '#ef4444';

            // Days tracked
            const daysTracked = chartData.dates ? chartData.dates.length : 0;
            document.getElementById('chart-days-tracked').textContent = daysTracked;
        }
    </script>
</body>
</html>
